---
title: "Neuro analyses"
output:
  html_document:
    theme: lumen
    toc: true
    toc_float: false
    code_download: true
    highlight: tango
---

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(readxl)
library(httr)
library(rcartocolor)
library(stringr)
library(forcats)
library(purrr)
theme_set(theme_bw() + theme(legend.title = element_blank()))
source('utils.R')
```

## Download data

```{r message=FALSE}
github_link <- 'https://raw.githubusercontent.com/covidclinical/Phase1.1AggregateDataPerSite/master/'
demo_link <- paste0(github_link, 'Demographics_persite_fakeID.csv')
diag_link <- paste0(github_link, 'Diagnoses_persite_fakeID.csv')

temp_file_1 <- temp_file_2 <- tempfile(fileext = ".csv")
req <- GET(demo_link, 
          # authenticate using GITHUB_PAT
           authenticate(Sys.getenv("GITHUB_PAT"), ""),
          # write result to disk
           write_disk(path = temp_file_1))
demo_all <- read_csv(temp_file_1)
unlink(temp_file_1)

req <- GET(diag_link, 
           authenticate(Sys.getenv("GITHUB_PAT"), ""),
           write_disk(path = temp_file_2))
diag_all <- read_csv(temp_file_2)
unlink(temp_file_2)
```

Notes:
- `num_patients_ever_severe_icd1`: number of patients having the icd code and ever being severe
- `num_patients_never_severe_icd1`: number of patients having the icd code and never being severe
- `num_patients_ever_severe_icd0`: number of patients not having the icd code and ever being severe
- `num_patients_never_severe_icd0`: number of patients not having the icd code and never being severe

## Read in local files

```{r include=FALSE}
# site_to_country <- read_csv('data/SiteID_Map_Non_Pediatric_3digit_toShare.csv') %>% 
#   mutate(Country = stringr::str_to_title(Country) %>% 
#            recode(Usa = 'US', 
#                   Singapore_spain = 'Singapore/Spain', 
#                   Uk = 'UK')) %>% 
#   select(SiteID = SiteID.new, Country)
# 
# # Check for duplicated mapping:
# site_to_country[duplicated(site_to_country$SiteID),]
```

<!-- Two rows have country SINGAPORE_SPAIN because there is only one site in each one of the countries. -->
<!-- If this were not combined: data could be known the specific site. -->

<!-- SITE660 was mapped to both US and France? -->
<!-- SITE309 was mapped to both US and Italy? -->
```{r}
icds_of_interest <- read_excel('data/2020-09-10_neuro-icd10.xlsx') %>% 
  rename('icd' = `ICD-10`)
```


# Descriptive statistics

`Diagnoses_persite_fakeID.csv` has `length(unique(diag_all$SiteID))` unique SiteID's.
`Demographics_persite_fakeID.csv` has `length(unique(demo_all$SiteID))` unique SiteID's.

## Mold data frames

```{r}
diag_ana <- diag_all %>% 
  mutate(all_nas = is.na(num_patients_ever_severe_icd0) & 
           is.na(num_patients_ever_severe_icd1) &
           is.na(num_patients_never_severe_icd0)&
           is.na(num_patients_never_severe_icd1)) %>% 
  filter(!all_nas) %>% 
  select(-all_nas) %>% 
  mutate(
    num_patients_icd = num_patients_ever_severe_icd1 + num_patients_never_severe_icd1,
    icd = gsub('icd:', '', icd),
    time = recode(time, 
                  before_admission = 'Before admission',
                  since_admission = 'After admission')) %>% 
  # left_join(site_to_country, by = 'SiteID') %>% 
  right_join(icds_of_interest, by = 'icd') %>% 
  distinct() %>% 
  mutate(full_icd = paste0(`ICD-10 Description`, ' (', icd, ')')) %>%
  {.}

demo_ana <- demo_all %>% 
  filter(race == 'all', age_group == 'all', sex == 'all') %>% 
  mutate(num_patients_never_severe = num_patients_all - num_patients_ever_severe) %>% 
  # left_join(site_to_country, by = 'SiteID') %>% 
  {.}

site_pats <- demo_ana %>% 
  group_by(SiteID) %>% 
  summarise(total_patients_per_site = sum(num_patients_all), .groups = 'drop')


```

<!-- # More quality check: -->

```{r include=FALSE, eval=FALSE}
# check_all <- demo_all %>% 
#   filter(race == 'all') 

# check whether the rows with race = all are actual sum of the rest
# check_race <- demo_all %>%
#   filter(race != 'all') %>%
#   group_by(SiteID, sex, age_group) %>%
#   summarise(num_patients_sum = sum(num_patients_all)) %>%
#   left_join(check_all)


# check_na <- check_race %>% 
#   filter(is.na(num_patients_all)) %>% 
#   pull(SiteID) %>% 
#   unique()

# length(unique(diag_all$SiteID))
check_diag <- diag_all %>% 
  filter(!is.na(num_patients_ever_severe_icd1)) %>% 
  mutate(num_patients_icd = num_patients_ever_severe_icd1 + num_patients_never_severe_icd1,
         icd = gsub('icd:', '', icd)) %>% 
  group_by(SiteID) %>%
  summarise(max_icd_pats_all = max(num_patients_icd, na.rm = T), .groups = 'drop') %>%
  left_join(demo_ana)

check_diag %>% 
  filter(max_icd_pats_all > num_patients_all)
```


```{r include=FALSE, eval=FALSE}
# country_pats <- demo_ana %>%
#   group_by(Country) %>%
#   summarise(total_patients_per_country = sum(num_patients_all), .groups = 'drop')

# dot_dat <- diag_ana %>%
#   group_by(SiteID, time, icd) %>%
#   summarise(pats_time_icd_ctry = sum(num_patients_icd), .groups = 'drop') %>%
#   left_join(site_pats, by = 'SiteID') %>%
#   mutate(percent_pats = pats_time_icd_ctry/total_patients_per_site)
# 
# dot_dat %>%
#   ggplot(aes(y = forcats::fct_reorder(icd, percent_pats), x = percent_pats, group = icd)) +
#     geom_point(aes(color = time)) +
#     geom_line() +
#     facet_grid(rows = vars(SiteID)) +
#   # scale_y_continuous(breaks = seq(0, 1, 0.1), labels = scales::percent_format(accuracy = 1)) +
#   scale_color_carto_d(palette = 4) +
#   labs(x = NULL, y = 'Percent patients')
    
```

Calculate percentages:

```{r fig.height=9}
code_prevalence <- diag_ana %>% 
  group_by(SiteID, time, icd, `Neurological Disease Category`, full_icd) %>% 
  summarise(pats_time_icd_site = sum(num_patients_icd), .groups = 'drop') %>% 
  left_join(site_pats, by = 'SiteID') %>% 
  mutate(percent_pats_site = pats_time_icd_site/total_patients_per_site,
         SiteID = as.factor(SiteID))

before_code_prev <- code_prevalence %>% 
  filter(time == 'Before admission',
         SiteID != 'SITE309') %>%
  ggplot(aes(y = icd, x = SiteID, fill = percent_pats_site)) +
  geom_tile() +
  labs(y = NULL, x = NULL) +
  #f6d2a9,#f5b78e,#f19c7c,#ea8171,#dd686c,#ca5268,#b13f64
  scale_fill_gradient(
    # low = '#f6d2a9', high = '#b13f64',
    low = '#d1eeea', high = '#2a5674',
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, 0.3),
    guide = guide_legend(override.aes = list(fill = "white"))) +
  scale_x_discrete(drop = F) + 
  facet_grid(rows = vars(`Neurological Disease Category`), space = 'free', scale = 'free') +
  heat_theme_top() +
  NULL

after_code_prev <- code_prevalence %>% 
  filter(time == 'After admission',
         SiteID != 'SITE309') %>%
  ggplot(aes(y = icd, x = SiteID, fill = percent_pats_site)) +
  geom_tile() +
  labs(y = NULL, x = NULL) +
  scale_x_discrete(drop = F) + 
  #d1eeea,#a8dbd9,#85c4c9,#68abb8,#4f90a6,#3b738f,#2a5674
  scale_fill_gradient(low = '#d1eeea', high = '#2a5674',
                      labels = scales::percent_format(accuracy = 1),
                      limits = c(0, 0.3)) +
  facet_grid(rows = vars(`Neurological Disease Category`), space = 'free', scale = 'free') +
  heat_theme_bottom() +
  NULL

heats <- cowplot::plot_grid(before_code_prev, after_code_prev, ncol = 1,
                            rel_heights = c(1, 1.15),
                   labels = c('A. Before admission', 'B. After admission'))
heats
ggsave('figs/icd_heatmap.png', heats, height = 10, width = 7)

```

```{r fig.height=6}
diff_code <- code_prevalence %>% 
  filter(SiteID != 'SITE309') %>%
  pivot_wider(names_from = time, values_from = percent_pats_site, id_cols = c(SiteID, icd, `Neurological Disease Category`), values_fill = 0) %>% 
  mutate(percent_diff = `After admission` - `Before admission`)

diff_heat <- diff_code %>% 
  ggplot(aes(y = icd, x = SiteID, fill = percent_diff)) +
  geom_tile() +
  labs(y = NULL, x = NULL, fill = 'After - Before') +
  scale_x_discrete(drop = F) + 
  #009392,#39b185,#9ccb86,#e9e29c,#eeb479,#e88471,#cf597e
  scale_fill_gradient2(
    low = '#009392',
    high = '#cf597e',
    labels = scales::percent_format(accuracy = 1)) +
  facet_grid(rows = vars(`Neurological Disease Category`), space = 'free', scale = 'free') +
  heat_theme_bottom() +
  NULL
diff_heat

ggsave('figs/icd_diff_heatmap.png', diff_heat, height = 5.5, width = 7)
```


```{r fig.width=10, fig.height=5}
icd_time <- diag_ana %>% 
  filter(SiteID != 'SITE309') %>% 
  group_by(full_icd, time) %>% 
  summarise(pats_icd_time = sum(num_patients_icd, na.rm = T), .groups = 'drop') 
sorted_icds <- icd_time %>% 
  filter(time == 'After admission') %>% 
  arrange(pats_icd_time) %>% 
  pull(full_icd)

total_icd <- icd_time %>% 
  ggplot(aes(x = pats_icd_time, y = fct_relevel(full_icd, sorted_icds), fill = time)) +
  scale_fill_carto_d(palette = 4, guide = guide_legend(reverse = TRUE)) +
  geom_col(position = 'dodge') +
  theme_minimal() +
  scale_x_reverse(expand = expansion(add = c(0,0))) +
  scale_y_discrete(labels = NULL) +
  theme(legend.position = c(0.25, 0.15),
        legend.title = element_blank(),
        legend.key.height = unit(4, 'mm')) +
  labs(x = 'Total number of patients at all sites', y = NULL)

percent_icd <- code_prevalence %>% 
  filter(SiteID != 'SITE309') %>% 
  ggplot(aes(x = percent_pats_site, 
             y = fct_relevel(full_icd, sorted_icds), 
             color = time)) +
  scale_color_carto_d(palette = 4, guide = NULL) +
  # scale_color_manual(values = c('#2a5674', '#b13f64')) + 
  geom_boxplot(fill = 'white') + 
  theme_minimal() +  
  theme(legend.position = c(0.75, 0.1),
        legend.title = element_blank(),
        axis.text.y = element_text(hjust = 0.5)) + 
  scale_x_continuous(expand = expansion(add = c(0, 0.05)),
                     labels = scales::percent_format(accuracy = 1)) +
  labs(x = 'Proportion of patients each site', y = NULL)

icd_prevalence_plots <- cowplot::plot_grid(total_icd, percent_icd, ncol = 2,
                   rel_widths = c(1, 2.5))
icd_prevalence_plots
ggsave('figs/icd_prevalence.png', icd_prevalence_plots, height = 5, width = 10)
```

# Severity analysis

What ICD code has the most number severe patients?
Sites with more severe patients?

```{r fig.height=9}
severe_code <- diag_ana %>% 
  filter(SiteID != 'SITE309') %>%
  mutate(percent_severe_site = num_patients_ever_severe_icd1/num_patients_icd,
         SiteID = as.factor(SiteID))

severe_bef_heat <- severe_code %>% 
  filter(time == 'Before admission') %>% 
  ggplot(aes(y = icd, x = SiteID, fill = percent_severe_site)) +
  geom_tile() +
  labs(y = NULL, x = NULL, fill = 'Severe % per ICD') +
  #3d5941,#778868,#b5b991,#f6edbd,#edbb8a,#de8a5a,#ca562c
  scale_fill_gradient(
    # low = '#f6d2a9', high = '#b13f64',
    low = 'white', high = '#ca562c',
    guide = guide_legend(override.aes = list(fill = "white")),
    ) +
  scale_x_discrete(drop = F) + 
  facet_grid(rows = vars(`Neurological Disease Category`), space = 'free', scale = 'free') +
  heat_theme_top() +
  NULL

severe_aft_heat <- severe_code %>% 
  filter(time == 'After admission') %>% 
  ggplot(aes(y = icd, x = SiteID, fill = percent_severe_site)) +
  geom_tile() +
  labs(y = NULL, x = NULL, fill = 'Severe % per ICD') +
  scale_x_discrete(drop = F) + 
  #3d5941,#778868,#b5b991,#f6edbd,#edbb8a,#de8a5a,#ca562c
  scale_fill_gradient(
    low = 'white', high = '#ca562c',
    labels = scales::percent_format(accuracy = 1)) +
  facet_grid(rows = vars(`Neurological Disease Category`), space = 'free', scale = 'free') +
  heat_theme_bottom() +
  NULL

severe_heats <- cowplot::plot_grid(severe_bef_heat, severe_aft_heat, ncol = 1,
                            rel_heights = c(1, 1.15),
                   labels = c('A. Before admission', 'B. After admission'))
severe_heats
ggsave('figs/icd_severe_heatmap.png', severe_heats, height = 10, width = 7)

```



# Severity enrichment analysis

## Null hypothesis: 
For each ICD code, the proportion of severe patients who were diagnosed with that ICD code is similar to the proportion of never-severe patients who were diagnosed with that same ICD code.

**Is "enrichment" the right word to use here?**

For the sake of simplicity in this notebook, we're going to denote patients whose symptoms have been categorized as severe (based on respiratory status +/- requiring ICU) at least once as *severe patients*, and patients whose symptoms have NEVER been categorized as severe as *non-severe patients*.

For each ICD code, we computed the expected number of *severe patients* by multiplying the proportion of *non-severe patients* who were diagnosed with that code with the total number of *severe patients*.
We performed an enrichment analysis to examine the difference of *severe patients* proportions across ICD codes.
We calculated each ICD code's enrichment by dividing the observed proportion of honorees by the expected proportion of honorees and reported a value of log2 enrichment (LOE) and its 95% confidence intervals.
The 95% confidence interval of the LOE was estimated using the Poisson model method [@isbn:9780849394447].

## Before admission

```{r}
confusion_df <- diag_ana %>% 
  filter(!SiteID %in% c('SITE660', 'SITE309'),
         time == 'Before admission') %>% 
  group_by(full_icd) %>% 
  summarise(across(contains('severe'), .fns = sum, na.rm = T), .groups = 'drop') %>% 
  mutate(Observed = num_patients_ever_severe_icd1, 
         num_non_severe = num_patients_never_severe_icd1 + num_patients_never_severe_icd0,
         num_severe = num_patients_ever_severe_icd1 + num_patients_ever_severe_icd0,
         Expected = num_patients_never_severe_icd1/num_non_severe*num_severe,
         over_sev = Observed - Expected)

nested_obs_exp <- confusion_df %>%
  select(full_icd, 
         num_patients_never_severe_icd0, 
         num_patients_never_severe_icd1, 
         num_patients_ever_severe_icd0, 
         num_patients_ever_severe_icd1) %>% 
  group_by(full_icd) %>% 
  nest() 

fish_obs_exp <- nested_obs_exp %>% 
  mutate(fish = map(data, my_fish)) %>% 
  dplyr::select(-data) %>% 
  unnest(cols = c(fish)) %>% 
  mutate(upper = ifelse(is.na(upper), Inf, upper))
```

### Country enrichment table {#enrichment_tab}

The full table with all ICD codes and their corresponding enrichment can be browsed interactively below:
```{r}
library(DT)
fish_obs_exp %>% 
  mutate(ci = paste0('(', round(log2(lower), 1), ', ', 
                     round(log2(upper), 1), ')'),
         lestimate = log2(estimate)) %>% 
  left_join(confusion_df, by = 'full_icd') %>% 
  select(full_icd, Observed, Expected, over_sev,
         estimate, lestimate, ci) %>%
  rename('ICD' = 'full_icd',
         'Observed - Expected' = 'over_sev',
         'Enrichment' = 'estimate',
         'Log2(enrichment)' = 'lestimate',
         '95% Confidence interval' = 'ci') %>%
  datatable(rownames = FALSE) %>% 
  formatRound(c('Observed', 'Expected', 'Observed - Expected',
                'Enrichment', 'Log2(enrichment)'), 1) %>%
  {.}
```

A positive value of LOE indicates a higher proportion of *severe patients* with that ICD code compared to *non-severe patients*.
A LOE value of 1 represents a one-fold enrichment (i.e., observed number of *severe patients* is twice as much as expected).
We found an excess of *severe patients* with the following ICD codes:

- Other disorders of the brain (G93): 63 more *severe patients* than expected, LOE = [], 95% CI []
- Other and unspecified myopathies (G72): 38 more *severe patients* than expected, LOE = [], 95% CI []
- Myositis (M60): 6 more *severe patients* than expected, LOE = [], 95% CI []

### Compute enrichment from proportion comparisons

```{r fig.width = 7, fig.height = 3.5}
filtered_obs_exp <- confusion_df %>% 
  left_join(fish_obs_exp, by = 'full_icd') %>% 
  mutate(
    distance_to_null = case_when(
      lower > 1 ~ lower - 1,
      TRUE ~ upper - 2
    ),
    presentation = case_when(
      lower > 1 ~ '#ca562c', 
      upper < 1 ~ '#009392',
      TRUE ~ 'grey20'
    ),
    full_icd =  as.factor(full_icd) %>% fct_reorder(num_patients_ever_severe_icd1)) %>% 
  arrange(desc(num_patients_ever_severe_icd1)) %>%
  {.}

plot_obs_exp <- filtered_obs_exp %>%
  mutate(lestimate = log2(estimate),
         llower = log2(lower), 
         lupper = log2(upper)) %>% 
  select(full_icd, lestimate, llower, lupper, presentation, over_sev, Observed, Expected) %>% 
  pivot_longer(- c(full_icd, presentation, over_sev), names_to = 'type') %>% 
  mutate(subtype = ifelse(type == 'Expected' | type == 'Observed', 
                          'Sqrt(number of honorees)', 
                          'Log2 enrichment, 95% CI')) 


```


```{r warning=FALSE, fig.width = 12, fig.height = 6}
plot_obs_exp_right <- plot_obs_exp %>% filter(subtype == 'Sqrt(number of honorees)')
plot_obs_exp_left <- plot_obs_exp %>% filter(subtype != 'Sqrt(number of honorees)')
sorted_icds <- rev(as.character(filtered_obs_exp$full_icd))
plot_obs_exp_before <- plot_obs_exp_left

enrichment_plot_left <- plot_obs_exp_left %>%
  ggplot(aes(x = fct_relevel(full_icd, sorted_icds))) +
  geom_pointrange(
    data = plot_obs_exp_left %>%
      pivot_wider(names_from = type),
    aes(y = lestimate,
        ymin = llower,
        ymax = lupper,
        group = full_icd),
    color = filtered_obs_exp$presentation,
    stroke = 0.3, fatten = 2
  ) +
  coord_flip() +
  labs(x = NULL, y = bquote(Log[2] ~ 'enrichment, 95% CI')) +
  theme(
    legend.position = c(0.9, 0.3),
    axis.title = element_text(size = 9),
    plot.margin = margin(5.5, 2, 5.5, 5.5, unit = 'pt')
  ) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  scale_x_discrete(position = 'top', labels = NULL) +
  scale_y_reverse() +
  geom_hline(data = plot_obs_exp_left, aes(yintercept = 0), linetype = 2)

over_severe_icds <- plot_obs_exp_right %>% 
  filter(over_sev > 0) %>% 
  pull(full_icd)

enrichment_plot_right <- plot_obs_exp_right %>%
  ggplot(aes(x = fct_relevel(full_icd, sorted_icds),
             y = value)) +
  geom_line(aes(group = full_icd, color = presentation)) +
  scale_color_manual(values = rev(unique(plot_obs_exp_right$presentation)),
                     guide = NULL) +
  geom_point(aes(shape = type), color = 'grey20') +
  labs(x = NULL, y = 'Number of ever severe patients') +
  theme(
    axis.title = element_text(size = 9),
    legend.position = c(0.75 , 0.1),
    axis.text.y = element_text(
      color = rev(filtered_obs_exp$presentation),
      hjust = 0.5),
    legend.background = element_blank(),
    legend.key.height = unit(3, 'mm'),
    legend.key.width = unit(3, 'mm'),
    plot.margin = margin(5.5, 5.5, 8.5, 2, unit = 'pt')
  ) +
  scale_y_sqrt() +
  coord_flip() +
  geom_text(
    data = . %>% 
      filter(type == 'Expected', !(full_icd %in% over_severe_icds)),
    nudge_y = 1.2, aes(label = round(over_sev, 1)), size = 2.5) +
  geom_text(
    data = . %>% 
      filter(type == 'Expected', full_icd %in% over_severe_icds), 
    nudge_y = -1.2, aes(label = round(over_sev, 1)), size = 2.5)

enrichment_plot <- cowplot::plot_grid(enrichment_plot_left, enrichment_plot_right,
                                rel_widths = c(1, 2.8))
enrichment_plot
ggsave('figs/icd_severe_bef.png', enrichment_plot, width = 9.5, height = 5)

```



## After admission

```{r echo=FALSE}
confusion_df <- diag_ana %>% 
  filter(!SiteID %in% c('SITE660', 'SITE309'),
         time == 'After admission') %>% 
  group_by(full_icd) %>% 
  summarise(across(contains('severe'), .fns = sum, na.rm = T), .groups = 'drop') %>% 
  mutate(Observed = num_patients_ever_severe_icd1, 
         num_non_severe = num_patients_never_severe_icd1 + num_patients_never_severe_icd0,
         num_severe = num_patients_ever_severe_icd1 + num_patients_ever_severe_icd0,
         Expected = num_patients_never_severe_icd1/num_non_severe*num_severe,
         over_sev = Observed - Expected)

nested_obs_exp <- confusion_df %>%
  select(full_icd, 
         num_patients_never_severe_icd0, 
         num_patients_never_severe_icd1, 
         num_patients_ever_severe_icd0, 
         num_patients_ever_severe_icd1) %>% 
  group_by(full_icd) %>% 
  nest() 

fish_obs_exp <- nested_obs_exp %>% 
  mutate(fish = map(data, my_fish)) %>% 
  dplyr::select(-data) %>% 
  unnest(cols = c(fish)) %>% 
  mutate(upper = ifelse(is.na(upper), Inf, upper))
```

### Country enrichment table {#enrichment_tab}

The full table with all ICD codes and their corresponding enrichment can be browsed interactively below:
```{r echo=FALSE}
library(DT)
fish_obs_exp %>% 
  mutate(ci = paste0('(', round(log2(lower), 1), ', ', 
                     round(log2(upper), 1), ')'),
         lestimate = log2(estimate)) %>% 
  left_join(confusion_df, by = 'full_icd') %>% 
  select(full_icd, Observed, Expected, over_sev,
         estimate, lestimate, ci) %>%
  rename('ICD' = 'full_icd',
         'Observed - Expected' = 'over_sev',
         'Enrichment' = 'estimate',
         'Log2(enrichment)' = 'lestimate',
         '95% Confidence interval' = 'ci') %>%
  datatable(rownames = FALSE) %>% 
  formatRound(c('Observed', 'Expected', 'Observed - Expected',
                'Enrichment', 'Log2(enrichment)'), 1) %>%
  {.}
```

A positive value of LOE indicates a higher proportion of *severe patients* with that ICD code compared to *non-severe patients*.
A LOE value of 1 represents a one-fold enrichment (i.e., observed number of *severe patients* is twice as much as expected).
We found an excess of *severe patients* with the following ICD codes:

-
- 
- 

### Compute enrichment from proportion comparisons

```{r fig.width = 7, fig.height = 3.5, echo=FALSE}
filtered_obs_exp <- confusion_df %>% 
  left_join(fish_obs_exp, by = 'full_icd') %>% 
  mutate(
    distance_to_null = case_when(
      lower > 1 ~ lower - 1,
      TRUE ~ upper - 2
    ),
    presentation = case_when(
      lower > 1 ~ '#ca562c', 
      upper < 1 ~ '#009392',
      TRUE ~ 'grey20'
    ),
    full_icd =  as.factor(full_icd) %>% fct_reorder(num_patients_ever_severe_icd1)) %>% 
  arrange(desc(num_patients_ever_severe_icd1)) %>%
  {.}

plot_obs_exp <- filtered_obs_exp %>%
  mutate(lestimate = log2(estimate),
         llower = log2(lower), 
         lupper = log2(upper)) %>% 
  select(full_icd, lestimate, llower, lupper, presentation, over_sev, Observed, Expected) %>% 
  pivot_longer(- c(full_icd, presentation, over_sev), names_to = 'type') %>% 
  mutate(subtype = ifelse(type == 'Expected' | type == 'Observed', 
                          'Sqrt(number of honorees)', 
                          'Log2 enrichment, 95% CI')) 


```


```{r warning=FALSE, fig.width = 12, fig.height = 6, echo=FALSE}
plot_obs_exp_right <- plot_obs_exp %>% filter(subtype == 'Sqrt(number of honorees)')
plot_obs_exp_left <- plot_obs_exp %>% filter(subtype != 'Sqrt(number of honorees)')
plot_obs_exp_after <- plot_obs_exp_left
sorted_icds <- rev(as.character(filtered_obs_exp$full_icd))

enrichment_plot_left <- plot_obs_exp_left %>%
  ggplot(aes(x = fct_relevel(full_icd, sorted_icds))) +
  geom_pointrange(
    data = plot_obs_exp_left %>%
      pivot_wider(names_from = type),
    aes(y = lestimate,
        ymin = llower,
        ymax = lupper,
        group = full_icd),
    color = filtered_obs_exp$presentation,
    stroke = 0.3, fatten = 2
  ) +
  coord_flip() +
  labs(x = NULL, y = bquote(Log[2] ~ 'enrichment, 95% CI')) +
  theme(
    legend.position = c(0.9, 0.3),
    axis.title = element_text(size = 9),
    plot.margin = margin(5.5, 2, 5.5, 5.5, unit = 'pt')
  ) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  scale_x_discrete(position = 'top', labels = NULL) +
  scale_y_reverse() +
  geom_hline(data = plot_obs_exp_left, aes(yintercept = 0), linetype = 2)

over_severe_icds <- plot_obs_exp_right %>% 
  filter(over_sev > 0) %>% 
  pull(full_icd)

enrichment_plot_right <- plot_obs_exp_right %>%
  ggplot(aes(x = fct_relevel(full_icd, sorted_icds),
             y = value)) +
  geom_line(aes(group = full_icd, color = presentation)) +
  scale_color_manual(values = unique(plot_obs_exp_right$presentation),
                     guide = NULL) +
  geom_point(aes(shape = type), color = 'grey20') +
  labs(x = NULL, y = 'Number of ever severe patients') +
  theme(
    axis.title = element_text(size = 9),
    legend.position = c(0.75 , 0.1),
    axis.text.y = element_text(
      color = rev(filtered_obs_exp$presentation),
      hjust = 0.5),
    legend.background = element_blank(),
    legend.key.height = unit(3, 'mm'),
    legend.key.width = unit(3, 'mm'),
    plot.margin = margin(5.5, 5.5, 8.5, 2, unit = 'pt')
  ) +
  scale_y_sqrt() +
  coord_flip() +
  geom_text(
    data = . %>% 
      filter(type == 'Expected', !(full_icd %in% over_severe_icds)),
    nudge_y = 1.2, aes(label = round(over_sev, 1)), size = 2.5) +
  geom_text(
    data = . %>% 
      filter(type == 'Expected', full_icd %in% over_severe_icds), 
    nudge_y = -1.2, aes(label = round(over_sev, 1)), size = 2.5)

enrichment_plot <- cowplot::plot_grid(enrichment_plot_left, enrichment_plot_right,
                                rel_widths = c(1, 2.8))
enrichment_plot
ggsave('figs/icd_severe_after.png', enrichment_plot, width = 9.5, height = 5)

```

Figure caption: 
Each ICD code's log2 enrichment (LOE) and its 95% confidence interval (left), and the absolute difference between observed (triangle) and expected (circle) number of *severe patients* (right) before admission.
Positive value of LOE indicates a higher proportion of *severe patients* with that ICD code compared to *non-severe patients*.
Neurological ICD codes are ordered based on the number of *severe patients*.

```{r fig.width=9}
enrichment_time <- plot_obs_exp_before %>%
  mutate(time = 'Before admission') %>% 
  bind_rows(plot_obs_exp_after %>% mutate(time = 'After admission'))

plot_enrich_both <- enrichment_time %>% 
  pivot_wider(names_from = type) %>% 
  ggplot(aes(y = fct_relevel(full_icd, sorted_icds))) +
  ggstance::geom_pointrangeh(
    aes(x = lestimate,
        xmin = llower,
        xmax = lupper,
        color = time),
    position = position_dodge(width = 0.3), 
    stroke = 0.1, fatten = 3, size = 0.7  
  ) +
  labs(y = NULL, x = bquote(Log[2] ~ 'enrichment, 95% CI')) +
  theme(
    legend.position = c(0.8, 0.93),
    legend.background = element_blank(),
    axis.title = element_text(size = 9),
    plot.margin = margin(5.5, 2, 5.5, 5.5, unit = 'pt')
  ) +
  scale_color_carto_d(palette = 4, guide = guide_legend(reverse = TRUE)) +
  geom_vline(aes(xintercept = 0), linetype = 2)
plot_enrich_both
ggsave('figs/icd_severe.png', plot_enrich_both, width = 9, height = 5)
```




