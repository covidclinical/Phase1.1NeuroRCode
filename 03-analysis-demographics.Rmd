---
title: "Analysis of demographics"
output:
  html_document:
    theme: lumen
    toc: true
    toc_float: false
    code_download: true
    highlight: tango
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

```{r warning=FALSE, message=FALSE}
library(readr)
library(dplyr)
library(scales)
library(tidyr)
library(ggplot2)
library(cowplot)
library(stringr)
library(forcats)

theme_set(theme_bw())
```

## Read in data
```{r}
alpha_threshold <- qnorm(0.975)
demo_desc <- read_csv('results/demo_prelim.csv')
colorBlindGrey6 <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#CC79A7")
demo_perc <- demo_desc %>% 
  mutate_at(vars(- num_patients_all, - siteid, - Country),
            list(~ . / .data$num_patients_all)) %>% 
  mutate(Country = as.factor(Country)) %>% 
  filter(siteid != 'SITE157', siteid != 'SITE712')
```

```{r}
unknowns <- demo_perc %>%
  select(siteid, Country, contains('unknown')) %>% 
  pivot_longer(- c(siteid, Country))
unknowns %>% filter(value < 0)
unknowns %>% filter(value < 1, value > 0.1)

unknowns %>% 
  ggplot(aes(y = value, x = name)) +
  ggbeeswarm::geom_beeswarm() +
  facet_wrap(~ name, scales = 'free')
```


## Severity vs. gender?
```{r}
demo_gender <- demo_perc %>% filter(unknown_other_sex < 1)
lm(num_patients_ever_severe ~ female, demo_gender) %>% 
  summary()

age_perc <- demo_perc %>% 
  filter(unknown_other_age_group < 1) %>% 
  select(Country, num_patients_all, num_patients_ever_severe, contains('to'), ends_with('plus'))

lm(num_patients_ever_severe ~ . - Country - num_patients_all, age_perc) %>% 
  summary()

age_radar <- age_perc %>% 
  select(-contains('num')) %>% 
  group_by(Country) %>% 
  summarise(across(.fns = mean_se), .groups = 'drop') %>% 
  pivot_longer(- Country) %>% 
  mutate(se = value$y - value$ymin,
         cimin = value$y - alpha_threshold*se,
         cimax = value$y + alpha_threshold*se)

races <- c("black",
           "hispanic_latino",
           "white",
           "asian",
           "hawaiian_pacific_islander",
           "american_indian")  
race_perc <- demo_perc %>% 
  filter(abs(unknown_other_race) < 1) %>% 
  select(Country, num_patients_all, num_patients_ever_severe, all_of(races))

race_radar <- race_perc %>% 
  select(-contains('num')) %>% 
  group_by(Country) %>% 
  summarise(across(.fns = mean_se), .groups = 'drop') %>% 
  pivot_longer(- Country) %>% 
  mutate(se = value$y - value$ymin,
         cimin = value$y - alpha_threshold*se,
         cimax = value$y + alpha_threshold*se,
         name = gsub('_', ' ', name) %>% 
           str_to_title(.) %>% 
           gsub('Hispanic ', 'Hispanic/', .) %>% 
           gsub('Hawaiian ', 'Hawaiian/', .),
         name = fct_reorder(name, value$y))

lm(num_patients_ever_severe ~ black + white + asian + hispanic_latino + american_indian +
     hawaiian_pacific_islander, race_perc) %>% 
  summary()
```

## Gender plot

```{r}
gender_plot <- demo_gender %>% 
  ggplot(aes(female, num_patients_ever_severe, 
             color = Country)) +
  geom_vline(xintercept = 0.5, linetype = 'dashed') +
  geom_point(aes(size = num_patients_all), alpha = 0.8) +
  scale_x_continuous(labels = scales::percent_format(),
                     limits = c(0, 0.65),
                     expand = expansion(add = c(0.18, 0))) +
  scale_y_continuous(labels = scales::percent_format(),
                     breaks = seq(0, 1, 0.2)) +
  labs(
    x = 'Proportion of female patients', 
    y = 'Proportion of severe cases', 
    color = NULL, 
    size = 'Total number of patients
at each site') +
  scale_size(trans = "log10") +
  scale_color_manual(values = colorBlindGrey6) +
  theme(legend.position = c(0.22, 0.4),
        plot.margin = margin(10.5, 5.5, 15.5, 5.5, 'pt'),
        legend.background = element_blank(),
        legend.key.height = unit(1, 'line'),
        legend.title = element_text(hjust = 0, size = 9)) +
  NULL
```

## Age plot

```{r}
age_plot <- age_radar %>%
  mutate(name = gsub('to', 'â€“', name) %>% gsub('plus', '+', .)) %>% 
  ggplot(aes(name, value$y, fill = Country, group = Country)) +
  geom_col(position = 'dodge2') + 
  coord_flip() +
  facet_grid(rows = vars(Country)) +
  geom_linerange(aes(ymin = cimin, ymax = cimax), 
                position = position_dodge(width = 0.9),
                color = 'grey50') +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     expand = expansion(add = c(0,0.02))) +
  scale_size_continuous(guide = FALSE) +
  labs(x = NULL, y = 'Proportion of patients in each age group') +
  scale_color_manual(values = colorBlindGrey6, drop = FALSE) +
  scale_fill_manual(values = colorBlindGrey6, drop = FALSE) +
  theme(legend.position = 'None',
        panel.grid.major.y = element_blank(),
        plot.margin = margin(10.5, 5.5, 6.5, 5.5, 'pt')) +
  NULL
```

## Race plot

```{r}
race_plot <- race_radar %>% 
  ggplot(aes(name, value$y, fill = Country, group = Country)) +
  geom_col(position = 'dodge2') + 
  coord_flip() +
  facet_grid(rows = vars(Country)) +
  geom_linerange(aes(ymin = cimin, ymax = cimax), 
                position = position_dodge(width = 0.9),
                color = 'grey50') +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     expand = expansion(add = c(0,0.02))) +
  scale_size_continuous(guide = FALSE) +
  labs(x = NULL, y = 'Patient proportion in each race/ethnicity group') +
  scale_color_manual(values = colorBlindGrey6, drop = FALSE) +
  scale_fill_manual(values = colorBlindGrey6, drop = FALSE) +
  theme(legend.position = 'None',
        panel.grid.major.y = element_blank(),
        ) +
  NULL
```

## Composite plot

```{r fig.width=10, fig.height=8, warning=FALSE}
gender_race <- plot_grid(gender_plot, race_plot, ncol = 1,
          rel_heights = c(2.9, 1), labels = 'AUTO')
comp_plots <- plot_grid(gender_race, age_plot, ncol = 2, rel_widths = c(1.3, 1),
          labels = c('', 'C'))
comp_plots
ggsave('figs/composite_plot.png', comp_plots, height = 6, width = 8)
```


```{r eval=FALSE, include=FALSE}
# age_radar <- age_perc %>% 
#   select(-contains('num')) %>% 
#   group_by(Country) %>% 
#   summarise(across(.fns = mean_se), .groups = 'drop') %>% 
#   mutate(Country = as.character(Country)) %>% 
#   rename(group = Country)
# 
# mtcars %>%
#      add_rownames( var = "group" ) %>%
#      mutate_each(funs(rescale), -group) %>%
#      tail(4) %>% select(1:10) -> mtcars_radar
# 
# ggradar(age_radar, 
#         values.radar = c(NA, paste0(c(25, 50), '%')),
#         group.colours = colorBlindGrey6[-4],
#         grid.mid = 0.25,
#         grid.max = 0.5,
#         base.size = 1)

age_perc %>% 
  pivot_longer(- c(Country, num_patients_all, num_patients_ever_severe)) %>% 
  ggplot(aes(value, num_patients_ever_severe, 
             color = Country)) +
  facet_wrap(~ name) +
  geom_point(aes(size = log2(num_patients_all)), alpha = 0.8) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_size_continuous(guide = FALSE) +
  labs(x = '% patients in each age group', y = '% severe cases') +
  scale_color_manual(values = colorBlindGrey6, drop = FALSE) +
  NULL

age_perc %>% 
  pivot_longer(- c(Country, num_patients_all, num_patients_ever_severe)) %>% 
  ggplot(aes(name, value, color = Country)) +
  # facet_grid(cols = vars(name), scales = 'free_x') +
  geom_boxplot(alpha = 0.8) +
  # geom_violin(aes(color = Country)) +
  # geom_jitter() +
  # geom_point(aes(size = log2(num_patients_all)), alpha = 0.8) +
  # scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  # scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_size_continuous(guide = FALSE) +
  labs(x = '% patients in each age group', y = '% patient') +
  scale_color_manual(values = colorBlindGrey6, drop = FALSE) +
  scale_fill_manual(values = colorBlindGrey6, drop = FALSE) +
  coord_polar() +
  NULL

race_perc %>% 
  pivot_longer(- c(Country, num_patients_all, num_patients_ever_severe)) %>% 
  ggplot(aes(value, num_patients_ever_severe, 
             color = Country)) +
  facet_wrap(~ name) +
  geom_point(aes(size = log2(num_patients_all)), alpha = 0.8) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  scale_size_continuous(guide = FALSE) +
  labs(x = '% patients in each race/ethnicity group', y = '% severe cases') +
  scale_color_manual(values = colorBlindGrey6, drop = FALSE, guide = FALSE) +
  NULL

race_perc %>% 
  pivot_longer(- c(Country, num_patients_all, num_patients_ever_severe)) %>% 
  ggplot(aes(name, value, color = Country)) +
  # facet_wrap(~ name) +
  # geom_point(aes(size = log2(num_patients_all)), alpha = 0.8) +
  geom_boxplot() +
  # scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  scale_size_continuous(guide = FALSE) +
  labs(x = '% patients in each race/ethnicity group', y = '% severe cases') +
  scale_color_manual(values = colorBlindGrey6, drop = FALSE, guide = FALSE) +
  NULL
```
